# **Dokumentacja Techniczna Modułu Liczników**

Wersja: 4.1 (Finalna)  
Data: 2025-08-02  
Lokalizacja modułu: /modules/licznik/

## **1\. Wprowadzenie**

Niniejszy dokument stanowi kompletną specyfikację techniczną dla modułu liczników i celów KPI. Jego celem jest dostarczenie programiście back-endu wszystkich informacji niezbędnych do integracji front-endu z istniejącą bazą danych (horusjcz\_liberty), zaimplementowania logiki biznesowej oraz systemu uprawnień opartym na lokalizacjach (sfid\_id).

## **2\. Architektura i Kluczowe Koncepcje**

### **2.1. Architektura oparta na Lokalizacji (SFID)**

* **Kluczowa zasada:** Wszystkie dane w tym module są ściśle powiązane z sfid\_id. Użytkownik ma dostęp wyłącznie do danych przypisanych do jego lokalizacji.  
* **Superadmin:** Jako jedyny ma możliwość przełączania widoku pomiędzy różnymi lokalizacjami. Domyślnie widzi dane dla swojej lokalizacji.

### **2.2. Mechanizm "Domyślnych" Liczników**

* **Cel:** Ułatwienie wdrożenia modułu w nowych lokalizacjach.  
* **Logika (Back-end):** Gdy użytkownik z nowego sfid\_id po raz pierwszy uruchamia moduł, system musi:  
  1. Sprawdzić, czy w tabeli stat\_counters istnieją rekordy dla tego sfid\_id.  
  2. Jeśli nie, system odnajduje wszystkie liczniki z flagą is\_default \= 1 i tworzy ich kopie, przypisując je do nowego sfid\_id.

## **3\. Struktura Bazy Danych**

Poniżej znajduje się finalna, sugerowana struktura nowych tabel, które należy dodać do bazy horusjcz\_liberty. Struktura jest spójna z istniejącymi tabelami users i sfid\_locations.

### **3.1. Tabela** stat\_counters **(Definicje Liczników)**

Przechowuje szablony liczników dla każdej lokalizacji.

CREATE TABLE \`stat\_counters\` (  
  \`id\` INT(11) NOT NULL AUTO\_INCREMENT,  
  \`sfid\_id\` INT(11) NOT NULL,  
  \`title\` VARCHAR(255) NOT NULL,  
  \`increment\` INT(11) NOT NULL DEFAULT 1,  
  \`type\` ENUM('number', 'currency') NOT NULL DEFAULT 'number',  
  \`symbol\` VARCHAR(10) DEFAULT NULL,  
  \`category\_id\` INT(11) NOT NULL,  
  \`is\_active\` TINYINT(1) NOT NULL DEFAULT 1,  
  \`is\_default\` TINYINT(1) NOT NULL DEFAULT 0,  
  PRIMARY KEY (\`id\`),  
  FOREIGN KEY (\`sfid\_id\`) REFERENCES \`sfid\_locations\`(\`id\`) ON DELETE CASCADE,  
  FOREIGN KEY (\`category\_id\`) REFERENCES \`stat\_categories\`(\`id\`)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4\_unicode\_ci;

### **3.2. Tabela** stat\_daily\_values **(Wartości Dziennych Liczników)**

Przechowuje codzienne wpisy wartości dla każdego licznika i użytkownika.

CREATE TABLE \`stat\_daily\_values\` (  
  \`id\` INT(11) NOT NULL AUTO\_INCREMENT,  
  \`date\` DATE NOT NULL,  
  \`user\_id\` INT(11) NOT NULL,  
  \`counter\_id\` INT(11) NOT NULL,  
  \`value\` INT(11) NOT NULL DEFAULT 0,  
  PRIMARY KEY (\`id\`),  
  UNIQUE KEY \`daily\_unique\` (\`date\`, \`user\_id\`, \`counter\_id\`),  
  FOREIGN KEY (\`user\_id\`) REFERENCES \`users\`(\`id\`) ON DELETE CASCADE,  
  FOREIGN KEY (\`counter\_id\`) REFERENCES \`stat\_counters\`(\`id\`) ON DELETE CASCADE  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4\_unicode\_ci;

### **3.3. Tabela** stat\_kpi\_goals **(Cele Zespołowe)**

Definiuje cele KPI dla poszczególnych lokalizacji.

CREATE TABLE \`stat\_kpi\_goals\` (  
  \`id\` INT(11) NOT NULL AUTO\_INCREMENT,  
  \`sfid\_id\` INT(11) NOT NULL,  
  \`name\` VARCHAR(255) NOT NULL,  
  \`totalGoal\` INT(11) NOT NULL,  
  PRIMARY KEY (\`id\`),  
  FOREIGN KEY (\`sfid\_id\`) REFERENCES \`sfid\_locations\`(\`id\`) ON DELETE CASCADE  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4\_unicode\_ci;

### **3.4. Tabela** stat\_kpi\_linked\_counters **(Powiązania KPI z Licznikami)**

Tabela łącząca (wiele-do-wielu) cele KPI z licznikami.

CREATE TABLE \`stat\_kpi\_linked\_counters\` (  
  \`kpi\_goal\_id\` INT(11) NOT NULL,  
  \`counter\_id\` INT(11) NOT NULL,  
  PRIMARY KEY (\`kpi\_goal\_id\`, \`counter\_id\`),  
  FOREIGN KEY (\`kpi\_goal\_id\`) REFERENCES \`stat\_kpi\_goals\`(\`id\`) ON DELETE CASCADE,  
  FOREIGN KEY (\`counter\_id\`) REFERENCES \`stat\_counters\`(\`id\`) ON DELETE CASCADE  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4\_unicode\_ci;

### **3.5. Tabela** stat\_kpi\_adjustments **(Korekty Ręczne KPI)**

Przechowuje informacje o ręcznych korektach wyników miesięcznych.

CREATE TABLE \`stat\_kpi\_adjustments\` (  
  \`id\` INT(11) NOT NULL AUTO\_INCREMENT,  
  \`kpi\_goal\_id\` INT(11) NOT NULL,  
  \`month\` VARCHAR(7) NOT NULL COMMENT 'Format: YYYY-MM',  
  \`value\` INT(11) NOT NULL,  
  \`reason\` TEXT,  
  \`admin\_id\` INT(11) NOT NULL,  
  \`created\_at\` TIMESTAMP NOT NULL DEFAULT CURRENT\_TIMESTAMP,  
  PRIMARY KEY (\`id\`),  
  FOREIGN KEY (\`kpi\_goal\_id\`) REFERENCES \`stat\_kpi\_goals\`(\`id\`) ON DELETE CASCADE,  
  FOREIGN KEY (\`admin\_id\`) REFERENCES \`users\`(\`id\`)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4\_unicode\_ci;

## **4\. System Uprawnień (Role) z uwzględnieniem SFID**

| Funkcja | user | admin | superadmin |
| :---- | :---- | :---- | :---- |
| **Liczniki (widok główny)** |  |  |  |
| Zmiana wartości (+/-) | **Tak** (tylko własne, tylko dziś, w ramach sfid\_id) | **Tak** (wszyscy w ramach sfid\_id) | **Tak** (wszyscy, w każdej sfid\_id) |
| Odblokowanie edycji historycznej | **Tak** (tylko własne) | **Tak** (w ramach sfid\_id) | **Tak** (wszyscy) |
| **Cele Zespołowe (KPI)** |  |  |  |
| Podgląd tabeli KPI | **Tak** (tylko dla sfid\_id) | **Tak** (tylko dla sfid\_id) | **Tak** (domyślnie własna sfid\_id, z opcją przełączenia na inną) |
| Dodawanie/Edycja/Usuwanie celów | Nie | **Tak** (w ramach sfid\_id) | **Tak** (wszystkie sfid\_id) |
| Korekta ręczna/masowa | Nie | **Tak** (w ramach sfid\_id) | **Tak** (wszystkie sfid\_id) |
| **Administracja** |  |  |  |
| Ustawienia licznika (kolor, krok) | Nie | **Tak** (w ramach sfid\_id) | **Tak** (wszystkie sfid\_id) |
| Dodawanie/Usuwanie liczników | Nie | **Tak** (w ramach sfid\_id) | **Tak** (wszystkie sfid\_id) |
| Ustawienie licznika jako "Domyślny" | Nie | Nie | **Tak** |

## **5\. Struktura Plików Front-end**

Aby ułatwić zarządzanie kodem, zaleca się podział plików JavaScript na mniejsze, logiczne moduły.

**Sugerowana struktura w katalogu /modules/licznik/:**

/modules/licznik/  
├── index.php         (Główny plik aplikacji)  
├── /api/  
│   ├── get\_app\_data.php  
│   ├── update\_daily\_value.php  
│   └── ... (pozostałe pliki API)  
└── /js/  
    ├── config.js     (Konfiguracja, dane statyczne)  
    ├── api.js        (Obsługa zapytań AJAX, funkcja apiCall)  
    ├── ui.js         (Funkcje renderujące interfejs i powiadomienia Toast)  
    ├── events.js     (Wszystkie event listeners i akcje użytkownika)  
    └── main.js       (Główny plik inicjalizujący aplikację)

**Sugerowana kolejność ładowania skryptów w index.php:**

\<script src="js/config.js"\>\</script\>  
\<script src="js/api.js"\>\</script\>  
\<script src="js/ui.js"\>\</script\>  
\<script src="js/events.js"\>\</script\>  
\<script src="js/main.js"\>\</script\>

## **6\. Kluczowe Zasady Bezpieczeństwa i Komunikacji API**

### **6.1. Zabezpieczenie przed Bezpośrednim Dostępem**

Każdy plik .php w katalogu API musi zawierać na początku mechanizm sprawdzający, czy został wywołany przez żądanie XMLHttpRequest (AJAX), a nie przez bezpośrednie wejście z paska adresu przeglądarki.

**Sugerowany kod na początku każdego pliku API:**

if (empty($\_SERVER\['HTTP\_X\_REQUESTED\_WITH'\]) || strtolower($\_SERVER\['HTTP\_X\_REQUESTED\_WITH'\]) \!= 'xmlhttprequest') {  
    http\_response\_code(403); // Forbidden  
    die(json\_encode(\['status' \=\> 'error', 'message' \=\> 'Brak bezpośredniego dostępu.'\]));  
}  
// ... reszta logiki API

### **6.2. Struktura Odpowiedzi API i Powiadomienia "Toast"**

Każda odpowiedź z API powinna być w formacie JSON i mieć ustandaryzowaną strukturę.

**Przykładowa odpowiedź sukcesu:**

{  
  "status": "success",  
  "message": "Cel KPI został pomyślnie zaktualizowany.",  
  "data": { ... } // Opcjonalne dane zwrotne  
}

**Przykładowa odpowiedź błędu (np. walidacji):**

{  
  "status": "error",  
  "message": "Brak uprawnień do wykonania tej akcji."  
}

**Przykładowa odpowiedź krytycznego błędu serwera (do celów deweloperskich):**

{  
  "status": "error",  
  "message": "Wystąpił błąd serwera. Skontaktuj się z administratorem.",  
  "debug\_info": "SQLSTATE\[42S02\]: Base table or view not found: 1146 Table 'horusjcz\_liberty.stat\_counters\_typo' doesn't exist"  
}

Front-end musi posiadać funkcję (showToast) do wyświetlania tych wiadomości. W trybie deweloperskim debug\_info może być wyświetlane w konsoli lub bezpośrednio w powiadomieniu.

### **6.3. Walidacja Uprawnień (Back-end)**

**NAJWAŻNIEJSZA ZASADA:** Każdy endpoint API po stronie serwera **musi** bezwzględnie weryfikować uprawnienia zalogowanego użytkownika, sprawdzając jego **rolę** oraz **sfid\_id** w kontekście zasobu, do którego próbuje uzyskać dostęp.

## **7\. Specyfikacja Endpointów API**

Wszystkie endpointy powinny znajdować się w katalogu /modules/licznik/api/.

* GET /modules/licznik/api/get\_app\_data.php: Pobiera wszystkie dane startowe.  
* GET /modules/licznik/api/get\_data\_for\_sfid.php?sfid\_id=\<id\>: **(Superadmin)** Pobiera dane dla wybranej lokalizacji.  
* GET /modules/licznik/api/get\_daily\_values.php?userId=\<id\>\&date=\<YYYY-MM-DD\>: Pobiera wartości liczników.  
* POST /modules/licznik/api/update\_daily\_value.php: Aktualizuje wartość licznika.  
* POST /modules/licznik/api/update\_counter\_settings.php: Aktualizuje ustawienia licznika.  
* POST /modules/licznik/api/save\_kpi\_goal.php: Tworzy/aktualizuje cel KPI.  
* POST /modules/licznik/api/delete\_kpi\_goal.php: Usuwa cel KPI.  
* POST /modules/licznik/api/save\_kpi\_adjustment.php: Dodaje ręczną korektę do celu KPI.  
* POST /modules/licznik/api/save\_mass\_correction.php: Zapisuje dane z korekty masowej.  
* GET /modules/licznik/api/get\_kpi\_details.php?goalId=\<id\>\&month=\<YYYY-MM\>: Pobiera dane do tabeli szczegółów.

## **8\. Opis Funkcji JavaScript**

### **8.1. api.js \- Komunikacja z Serwerem**

* **apiCall(action, params)**  
  * **Opis:** Centralna funkcja do wysyłania wszystkich zapytań do API. Przyjmuje nazwę akcji (np. get\_app\_data) i obiekt z parametrami. Konstruuje zapytanie fetch, wysyła je do odpowiedniego pliku .php i obsługuje odpowiedź.  
  * **Obsługa błędów:** Ta funkcja jest kluczowa dla debugowania. Musi przechwytywać błędy sieciowe (catch(error)), błędy HTTP (sprawdzając response.ok) oraz błędy parsowania JSON. Każdy błąd powinien być wyświetlony za pomocą showToast z jak największą ilością szczegółów.  
  * **Zależności:** showToast.

### **8.2. ui.js \- Interfejs Użytkownika**

* **showToast(message, type \= 'info', debugInfo \= null)**  
  * **Opis:** Wyświetla na ekranie powiadomienie "Toast". Przyjmuje treść wiadomości, typ (success, error, info) oraz opcjonalne informacje debugowania.  
  * **Zależności:** Brak.  
* **renderAll() i pozostałe funkcje render...()**  
  * **Opis:** Odpowiedzialne za generowanie i odświeżanie HTML w aplikacji. Ich logika pozostaje bez zmian.

### **8.3. events.js \- Akcje Użytkownika**

* **changeValue(id, amount)**  
  * **Opis:** Wywołuje apiCall('update\_daily\_value', { ... }). Po otrzymaniu odpowiedzi success odświeża interfejs.  
  * **Zależności:** apiCall, renderAll.  
* **saveSettings() / saveKpiGoal() / etc.**  
  * **Opis:** Zbierają dane z formularzy i wywołują odpowiednie akcje w apiCall, np. apiCall('save\_kpi\_goal', { ... }).  
  * **Zależności:** apiCall, renderAll.

### **8.4. main.js \- Inicjalizacja**

* **DOMContentLoaded listener**  
  * **Opis:** Główny punkt startowy aplikacji. Wywołuje apiCall('get\_app\_data') w celu pobrania danych startowych, a następnie inicjalizuje wszystkie komponenty (SortableJS) i nasłuchiwacze zdarzeń.  
  * **Zależności:** apiCall, renderAll, Sortable.