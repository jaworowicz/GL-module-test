<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do Kanban - Mockup</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="mockup.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-tasks"></i> To-Do Kanban Board</h1>
            <div class="controls">
                <select id="locationFilter" class="custom-select">
                    <option value="all">Wszystkie lokalizacje</option>
                    <option value="20004014">BAZA 20004014</option>
                    <option value="20004015">BAZA 20004015</option>
                </select>
                <select id="userFilter" class="custom-select">
                    <option value="all">Wszyscy użytkownicy</option>
                    <option value="1">Jakub Jaworowicz</option>
                    <option value="2">Anna Kowalska</option>
                    <option value="3">Piotr Nowak</option>
                </select>
                <button class="btn btn-primary" onclick="openTaskModal()">
                    <i class="fas fa-plus"></i> Dodaj zadanie
                </button>
            </div>
        </header>

        <div class="kanban-board">
            <div class="kanban-column" data-status="new">
                <div class="column-header">
                    <div class="column-title">
                        <i class="fas fa-inbox"></i>
                        Nowe
                        <span class="task-count" id="new-count">0</span>
                    </div>
                </div>
                <div class="drop-zone" id="new-tasks"></div>
            </div>

            <div class="kanban-column" data-status="in-progress">
                <div class="column-header">
                    <div class="column-title">
                        <i class="fas fa-play"></i>
                        W toku
                        <span class="task-count" id="in-progress-count">0</span>
                    </div>
                </div>
                <div class="drop-zone" id="in-progress-tasks"></div>
            </div>

            <div class="kanban-column" data-status="returned">
                <div class="column-header">
                    <div class="column-title">
                        <i class="fas fa-undo"></i>
                        Zwrócone
                        <span class="task-count" id="returned-count">0</span>
                    </div>
                </div>
                <div class="drop-zone" id="returned-tasks"></div>
            </div>

            <div class="kanban-column" data-status="completed">
                <div class="column-header">
                    <div class="column-title">
                        <i class="fas fa-check"></i>
                        Zakończone
                        <span class="task-count" id="completed-count">0</span>
                    </div>
                </div>
                <div class="drop-zone" id="completed-tasks"></div>
            </div>
        </div>

        <!-- Widget responsywny -->
        <div class="widget-container">
            <h3 class="widget-title">
                <i class="fas fa-list-check"></i> 
                Moje zadania do wykonania
            </h3>
            <div class="widget-tasks" id="widget-tasks"></div>
        </div>

        <!-- Widget Administratora/Superadministratora -->
        <div class="admin-widget-container" id="admin-widget">
            <h3 class="admin-widget-title">
                <i class="fas fa-shield-alt"></i> 
                Panel Administratora / Superadministratora
            </h3>
            <div class="admin-stats-grid">
                <div class="admin-stat-card">
                    <span class="admin-stat-value" id="stat-new">0</span>
                    <span class="admin-stat-label">Nowe zadania</span>
                </div>
                <div class="admin-stat-card">
                    <span class="admin-stat-value" id="stat-progress">0</span>
                    <span class="admin-stat-label">W toku</span>
                </div>
                <div class="admin-stat-card">
                    <span class="admin-stat-value" id="stat-returned">0</span>
                    <span class="admin-stat-label">Zwrócone</span>
                </div>
                <div class="admin-stat-card">
                    <span class="admin-stat-value" id="stat-completed">0</span>
                    <span class="admin-stat-label">Zakończone</span>
                </div>
            </div>
            <div class="admin-widget-title">
                <i class="fas fa-bell"></i> 
                Zadania wymagające uwagi
            </div>
            <div class="admin-priority-tasks" id="admin-priority-tasks">
                <!-- Tutaj będą ładowane zadania wymagające uwagi -->
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji zadania -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Dodaj nowe zadanie</h2>
                <button type="button" class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Tytuł zadania *</label>
                    <input type="text" id="taskTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Opis</label>
                    <textarea id="taskDescription" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Typ przypisania *</label>
                    <select id="taskAssignmentType" class="form-select" required onchange="toggleUserSelect()">
                        <option value="">Wybierz typ</option>
                        <option value="global">Globalne (dla wszystkich w lokalizacji)</option>
                        <option value="user">Dla konkretnego użytkownika</option>
                        <option value="self">Tylko dla siebie</option>
                    </select>
                </div>
                <div class="form-group" id="userSelectGroup" style="display: none;">
                    <label class="form-label">Użytkownik</label>
                    <select id="taskAssignedUser" class="form-select">
                        <option value="1">Jakub Jaworowicz</option>
                        <option value="2">Anna Kowalska</option>
                        <option value="3">Piotr Nowak</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokalizacja</label>
                    <select id="taskLocation" class="form-select">
                        <option value="20004014">BAZA 20004014</option>
                        <option value="20004015">BAZA 20004015</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Termin wykonania</label>
                    <input type="date" id="taskDueDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Priorytet</label>
                    <select id="taskPriority" class="form-select">
                        <option value="low">Niski</option>
                        <option value="medium">Średni</option>
                        <option value="high">Wysoki</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="taskStatus" class="form-select">
                        <option value="new">Nowe</option>
                        <option value="in-progress">W toku</option>
                        <option value="returned">Zwrócone</option>
                        <option value="completed">Zakończone</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Zapisz zadanie
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">
                        <i class="fas fa-times"></i> Anuluj
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal potwierdzenia -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <h3 class="confirm-modal-title">
                <i class="fas fa-exclamation-triangle"></i>
                Potwierdź działanie
            </h3>
            <p class="confirm-modal-text" id="confirmModalText"></p>
            <div class="confirm-modal-actions">
                <button type="button" class="btn btn-danger" id="confirmModalOk">
                    <i class="fas fa-check"></i> Tak
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i> Nie
                </button>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Globalne zmienne
        let tasks = [];
        let editingTaskId = null;
        let currentUser = 1; // Symulacja aktualnego użytkownika
        let confirmCallback = null;
        let dragStartTime = 0;
        let isDragging = false;

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            renderTasks();
            renderWidget();
            setupDragAndDrop();
            setupTouchEvents();
            setupFilters(); // Call setupFilters here
            // Ustawienie domyślnego filtra użytkownika na bieżącego użytkownika
            document.getElementById('userFilter').value = currentUser;
            // Symulacja admina dla demonstracji
            if (currentUser === 1) { // Zakładamy, że użytkownik 1 to administrator
                document.getElementById('admin-widget').style.display = 'block';
            }
        });

        // Modal potwierdzenia
        function showConfirm(message, callback) {
            document.getElementById('confirmModalText').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        document.getElementById('confirmModalOk').addEventListener('click', function() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        });

        // Funkcje pomocnicze dla dat
        function formatDueDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);

            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return `Przeterminowane (${Math.abs(diffDays)} dni)`;
            } else if (diffDays === 0) {
                return 'Dziś ostatni dzień!';
            } else if (diffDays === 1) {
                return 'Jutro';
            } else {
                return `Za ${diffDays} dni`;
            }
        }

        function getDueDateClass(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);

            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return 'due-overdue';
            } else if (diffDays === 0) {
                return 'due-today';
            }
            return '';
        }

        // Zarządzanie zadaniami
        function loadTasks() {
            const savedTasks = localStorage.getItem('kanban_tasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            } else {
                // Przykładowe zadania z terminami
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                tasks = [
                    {
                        id: 1,
                        title: 'Sprawdzenie sprzętu technicznego',
                        description: 'Kontrola stanu technicznego urządzeń w lokalizacji',
                        assignmentType: 'global',
                        assignedUser: null,
                        location: '20004014',
                        priority: 'high',
                        status: 'new',
                        dueDate: today.toISOString().split('T')[0],
                        createdBy: 1,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        title: 'Przygotowanie raportu miesięcznego',
                        description: 'Sporządzenie raportu z wyników za bieżący miesiąc',
                        assignmentType: 'user',
                        assignedUser: 2,
                        location: '20004014',
                        priority: 'medium',
                        status: 'in-progress',
                        dueDate: tomorrow.toISOString().split('T')[0],
                        createdBy: 1,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        title: 'Aktualizacja bazy klientów',
                        description: 'Weryfikacja i aktualizacja danych kontaktowych',
                        assignmentType: 'self',
                        assignedUser: 1,
                        location: '20004014',
                        priority: 'low',
                        status: 'completed',
                        dueDate: yesterday.toISOString().split('T')[0],
                        createdBy: 1,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 4,
                        title: 'Korekta faktury nr 123/2024',
                        description: 'Błąd w naliczonej kwocie VAT',
                        assignmentType: 'user',
                        assignedUser: 1,
                        location: '20004015',
                        priority: 'high',
                        status: 'returned',
                        dueDate: yesterday.toISOString().split('T')[0],
                        createdBy: 2,
                        createdAt: new Date().toISOString()
                    }
                ];
                saveTasks();
            }
        }

        function saveTasks() {
            localStorage.setItem('kanban_tasks', JSON.stringify(tasks));
        }

        function renderTasks() {
            const columns = {
                'new': document.getElementById('new-tasks'),
                'in-progress': document.getElementById('in-progress-tasks'),
                'returned': document.getElementById('returned-tasks'),
                'completed': document.getElementById('completed-tasks')
            };

            // Wyczyść kolumny
            Object.values(columns).forEach(column => {
                column.innerHTML = '';
            });

            // Filtruj zadania
            const filteredTasks = getFilteredTasks();

            // Renderuj zadania
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                columns[task.status].appendChild(taskElement);
            });

            // Aktualizuj liczniki
            updateTaskCounts();
        }

        function getFilteredTasks() {
            const locationFilter = document.getElementById('locationFilter').value;
            const userFilter = document.getElementById('userFilter').value;

            return tasks.filter(task => {
                // Filtr lokalizacji
                if (locationFilter !== 'all' && task.location !== locationFilter) {
                    return false;
                }

                // Filtr użytkownika
                if (userFilter !== 'all') {
                    const userId = parseInt(userFilter);
                    // Zadanie jest widoczne, jeśli jest przypisane do wybranego użytkownika
                    // lub jest typu globalne (widoczne dla wszystkich)
                    if (task.assignmentType === 'global') {
                        // Globalne zadania są widoczne dla wszystkich
                    } else if (task.assignmentType === 'user' && task.assignedUser !== userId) {
                        return false;
                    } else if (task.assignmentType === 'self' && task.assignedUser !== userId) {
                        return false;
                    } else if (task.assignmentType !== 'self' && task.assignmentType !== 'user' && task.assignmentType !== 'global') {
                         // Obsługa nieznanych typów przypisania, jeśli istnieją
                        return false;
                    }
                }

                return true;
            });
        }

        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-card';
            taskDiv.draggable = true;
            taskDiv.dataset.taskId = task.id;

            const assignmentTypeClass = `type-${task.assignmentType}`;
            const assignmentTypeText = {
                'global': 'Globalne',
                'user': 'Użytkownik',
                'self': 'Własne'
            }[task.assignmentType] || task.assignmentType; // Fallback for safety

            const userName = task.assignedUser ? getUserName(task.assignedUser) : 'Wszyscy';
            const dueDateClass = getDueDateClass(task.dueDate);

            if (dueDateClass) {
                taskDiv.classList.add(dueDateClass);
            }

            const dueDateHtml = task.dueDate ? `
                <div class="task-due-date ${dueDateClass}">
                    <i class="fas fa-calendar"></i> ${formatDueDate(task.dueDate)}
                </div>
            ` : '';

            taskDiv.innerHTML = `
                <div class="task-priority priority-${task.priority}"></div>
                <div class="task-title">${escapeHtml(task.title)}</div>
                <div class="task-description">${escapeHtml(task.description || '')}</div>
                <div class="task-meta">
                    <div class="task-assignee">
                        <span class="assignee-type ${assignmentTypeClass}">${assignmentTypeText}</span>
                        <span>${userName}</span>
                    </div>
                    <div>ID: ${task.location}</div>
                </div>
                ${dueDateHtml}
                <div class="task-actions">
                    <button class="task-action-btn btn-edit" onclick="event.stopPropagation(); editTask(${task.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="task-action-btn btn-delete" onclick="event.stopPropagation(); deleteTask(${task.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return taskDiv;
        }

        function getUserName(userId) {
            const users = {
                1: 'Jakub Jaworowicz',
                2: 'Anna Kowalska',
                3: 'Piotr Nowak'
            };
            return users[userId] || 'Nieznany';
        }

        function updateTaskCounts() {
            const filteredTasks = getFilteredTasks();
            const counts = {
                'new': 0,
                'in-progress': 0,
                'returned': 0,
                'completed': 0
            };

            filteredTasks.forEach(task => {
                counts[task.status]++;
            });

            Object.keys(counts).forEach(status => {
                const countElement = document.getElementById(`${status}-count`);
                if (countElement) {
                    countElement.textContent = counts[status];
                }
            });
        }

        // Modal zarządzanie
        function openTaskModal(taskId = null) {
            editingTaskId = taskId;
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('modalTitle');

            if (taskId) {
                title.textContent = 'Edytuj zadanie';
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description;
                    document.getElementById('taskAssignmentType').value = task.assignmentType;
                    document.getElementById('taskAssignedUser').value = task.assignedUser || '';
                    document.getElementById('taskLocation').value = task.location;
                    document.getElementById('taskDueDate').value = task.dueDate || '';
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskStatus').value = task.status;
                    toggleUserSelect();
                }
            } else {
                title.textContent = 'Dodaj nowe zadanie';
                document.getElementById('taskForm').reset();
                document.getElementById('userSelectGroup').style.display = 'none'; // Reset user select visibility
            }

            modal.style.display = 'block';
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }

        function toggleUserSelect() {
            const assignmentType = document.getElementById('taskAssignmentType').value;
            const userSelectGroup = document.getElementById('userSelectGroup');

            if (assignmentType === 'user') {
                userSelectGroup.style.display = 'block';
            } else {
                userSelectGroup.style.display = 'none';
            }
        }

        // Obsługa formularza
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                assignmentType: document.getElementById('taskAssignmentType').value,
                assignedUser: document.getElementById('taskAssignedUser').value || null,
                location: document.getElementById('taskLocation').value,
                dueDate: document.getElementById('taskDueDate').value || '', // Changed to empty string if null
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value
            };

            if (formData.assignmentType === 'self') {
                formData.assignedUser = currentUser;
            } else if (formData.assignmentType === 'global') {
                formData.assignedUser = null;
            } else if (formData.assignmentType === 'user') {
                formData.assignedUser = parseInt(formData.assignedUser);
            }

            if (editingTaskId) {
                // Edycja zadania
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...formData };
                }
            } else {
                // Dodanie nowego zadania
                const newTask = {
                    id: Date.now(),
                    ...formData,
                    createdBy: currentUser,
                    createdAt: new Date().toISOString()
                };
                tasks.push(newTask);
            }

            saveTasks();
            renderTasks();
            renderWidget();
            closeTaskModal();
        });

        function editTask(taskId) {
            openTaskModal(taskId);
        }

        function deleteTask(taskId) {
            showConfirm('Czy na pewno chcesz usunąć to zadanie?', function() {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                renderTasks();
                renderWidget();
            });
        }

        // Drag & Drop with improved mobile support
        let draggedElement = null;
        let initialX = 0;
        let initialY = 0;
        let currentX = 0;
        let currentY = 0;

        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.drop-zone');

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });

            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragend', handleDragEnd);
        }

        function setupTouchEvents() {
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
        }

        function handleTouchStart(e) {
            const target = e.target.closest('.task-card');
            if (target && !e.target.closest('.task-action-btn')) {
                dragStartTime = Date.now();
                isDragging = false;

                draggedElement = target;
                const touch = e.touches[0];
                initialX = touch.clientX;
                initialY = touch.clientY;
                currentX = touch.clientX;
                currentY = touch.clientY;

                // Opóźnienie przed rozpoczęciem przeciągania
                setTimeout(() => {
                    if (draggedElement && !isDragging) {
                        isDragging = true;
                        target.classList.add('dragging', 'mobile-drag-mode');
                        target.style.position = 'fixed';
                        target.style.zIndex = '1000';
                        target.style.pointerEvents = 'none';
                        target.style.transform = 'rotate(3deg) scale(1.05)';
                        target.style.left = (currentX - 50) + 'px';
                        target.style.top = (currentY - 50) + 'px';
                    }
                }, 200);
            }
        }

        function handleTouchMove(e) {
            if (!draggedElement) return;

            const touch = e.touches[0];
            currentX = touch.clientX;
            currentY = touch.clientY;

            const deltaX = Math.abs(currentX - initialX);
            const deltaY = Math.abs(currentY - initialY);

            // Rozpocznij przeciąganie jeśli ruch jest większy niż 10px
            if ((deltaX > 10 || deltaY > 10) && !isDragging) {
                isDragging = true;
                draggedElement.classList.add('dragging', 'mobile-drag-mode');
                draggedElement.style.position = 'fixed';
                draggedElement.style.zIndex = '1000';
                draggedElement.style.pointerEvents = 'none';
                draggedElement.style.transform = 'rotate(3deg) scale(1.05)';
            }

            if (isDragging) {
                e.preventDefault();

                draggedElement.style.left = (currentX - 50) + 'px';
                draggedElement.style.top = (currentY - 50) + 'px';

                // Znajdź kolumnę pod palcem
                const elementBelow = document.elementFromPoint(currentX, currentY);
                const dropZone = elementBelow?.closest('.drop-zone');

                // Usuń poprzednie podświetlenia
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.remove('drag-over');
                });

                // Dodaj podświetlenie do aktualnej kolumny
                if (dropZone) {
                    dropZone.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(e) {
            if (!draggedElement) return;

            // Jeśli nie było przeciągania, pozwól na normalne kliknięcia
            if (!isDragging) {
                draggedElement = null;
                return;
            }

            e.preventDefault();

            // Znajdź kolumnę pod miejscem puszczenia
            const elementBelow = document.elementFromPoint(currentX, currentY);
            const dropZone = elementBelow?.closest('.drop-zone');

            if (dropZone) {
                const newStatus = dropZone.id.replace('-tasks', '');
                const taskId = parseInt(draggedElement.dataset.taskId);
                const task = tasks.find(t => t.id === taskId);

                if (task && task.status !== newStatus) {
                    task.status = newStatus;
                    saveTasks();
                    renderTasks();
                    renderWidget();
                }
            }

            // Przywróć element do normalnego stanu
            draggedElement.classList.remove('dragging', 'mobile-drag-mode');
            draggedElement.style.position = '';
            draggedElement.style.zIndex = '';
            draggedElement.style.pointerEvents = '';
            draggedElement.style.transform = '';
            draggedElement.style.left = '';
            draggedElement.style.top = '';

            // Usuń podświetlenia
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });

            draggedElement = null;
            isDragging = false;
        }

        function handleDragStart(e) {
            if (e.target.classList.contains('task-card')) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            }
        }

        function handleDragEnd(e) {
            if (e.target.classList.contains('task-card')) {
                e.target.classList.remove('dragging');
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const taskId = parseInt(e.dataTransfer.getData('text/plain'));
            const newStatus = e.currentTarget.id.replace('-tasks', '');

            const task = tasks.find(t => t.id === taskId);
            if (task && task.status !== newStatus) {
                task.status = newStatus;
                saveTasks();
                renderTasks();
                renderWidget();
            }
        }

        // Widget
        function renderWidget() {
            renderUserWidget();
            renderAdminWidget();
        }

        function renderUserWidget() {
            const widgetContainer = document.getElementById('widget-tasks');
            const myTasks = tasks.filter(task => {
                // Filtruj zadania przypisane do użytkownika
                return (task.assignmentType === 'self' && task.assignedUser === currentUser) ||
                       (task.assignmentType === 'user' && task.assignedUser === currentUser) ||
                       (task.assignmentType === 'global');
            });

            widgetContainer.innerHTML = '';

            if (myTasks.length === 0) {
                widgetContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">Brak zadań do wykonania</p>';
                return;
            }

            myTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'widget-task';

                const dueDateClass = getDueDateClass(task.dueDate);
                if (dueDateClass) {
                    taskDiv.classList.add(dueDateClass);
                }

                const dueDateHtml = task.dueDate ? `
                    <div class="widget-task-due ${dueDateClass}">
                        ${formatDueDate(task.dueDate)}
                    </div>
                ` : '';

                taskDiv.innerHTML = `
                    <label class="custom-checkbox">
                        <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                               onchange="toggleTaskCompletion(${task.id}, this.checked)">
                        <span class="checkbox-checkmark"></span>
                    </label>
                    <div class="widget-task-text ${task.status === 'completed' ? 'completed' : ''}">
                        <strong>${escapeHtml(task.title)}</strong>
                        <small>${escapeHtml(task.description || '')}</small>
                        ${dueDateHtml}
                    </div>
                    <span class="assignee-type type-${task.assignmentType}">${task.assignmentType}</span>
                `;

                widgetContainer.appendChild(taskDiv);
            });
        }

        function renderAdminWidget() {
            // Widget admina pokazuje się zawsze w mockup dla demonstracji
            const adminWidget = document.getElementById('admin-widget');
            // Sprawdzenie czy użytkownik jest adminem (tutaj zakładamy, że currentUser === 1 jest adminem)
            if (currentUser === 1) {
                adminWidget.style.display = 'block';
            } else {
                adminWidget.style.display = 'none';
                return; // Jeśli nie jest adminem, nie renderujemy tego widgetu
            }

            // Statystyki
            const stats = {
                new: tasks.filter(t => t.status === 'new').length,
                progress: tasks.filter(t => t.status === 'in-progress').length,
                returned: tasks.filter(t => t.status === 'returned').length,
                completed: tasks.filter(t => t.status === 'completed').length
            };

            document.getElementById('stat-new').textContent = stats.new;
            document.getElementById('stat-progress').textContent = stats.progress;
            document.getElementById('stat-returned').textContent = stats.returned;
            document.getElementById('stat-completed').textContent = stats.completed;

            // Zadania wymagające uwagi
            const priorityTasks = tasks.filter(task => {
                const dueDateClass = getDueDateClass(task.dueDate);
                return task.status === 'returned' || dueDateClass === 'due-overdue' || dueDateClass === 'due-today';
            });

            const priorityContainer = document.getElementById('admin-priority-tasks');
            priorityContainer.innerHTML = '';

            if (priorityTasks.length === 0) {
                priorityContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 15px; font-size: 0.8rem;">Brak zadań wymagających uwagi</p>';
                return;
            }

            priorityTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'admin-priority-task';

                const dueDateClass = getDueDateClass(task.dueDate);
                let statusClass = '';
                let icon = 'fas fa-info-circle';

                if (task.status === 'returned') {
                    statusClass = 'status-returned';
                    icon = 'fas fa-undo';
                } else if (dueDateClass === 'due-overdue') {
                    statusClass = 'status-overdue';
                    icon = 'fas fa-exclamation-triangle';
                } else if (dueDateClass === 'due-today') {
                    statusClass = 'status-warning'; // Placeholder, needs actual definition if used
                    icon = 'fas fa-clock';
                } else {
                    // Default status for other cases if needed
                    statusClass = 'status-new'; // Or 'status-in-progress'
                }

                // Ensure statusClass is one of the defined ones or a default
                const validStatusClasses = ['status-new', 'status-in-progress', 'status-returned', 'status-completed', 'status-overdue'];
                if (!validStatusClasses.includes(statusClass)) {
                    // If the determined class isn't valid, assign a default based on task status
                    if (task.status === 'new') statusClass = 'status-new';
                    else if (task.status === 'in-progress') statusClass = 'status-in-progress';
                    else if (task.status === 'completed') statusClass = 'status-completed';
                    else statusClass = 'status-new'; // Fallback
                }


                const statusText = {
                    'returned': 'Zwrócone',
                    'new': 'Nowe',
                    'in-progress': 'W toku',
                    'completed': 'Zakończone'
                }[task.status];

                const assigneeText = task.assignmentType === 'global' ? 'Globalne' :
                                   task.assignmentType === 'self' ? 'Własne' :
                                   getUserName(task.assignedUser);

                taskDiv.innerHTML = `
                    <div class="admin-task-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="admin-task-content">
                        <div class="admin-task-title">${escapeHtml(task.title)}</div>
                        <div class="admin-task-meta">
                            ${assigneeText} • ${task.location || 'Brak lokalizacji'}
                            ${task.dueDate ? ' • ' + formatDueDate(task.dueDate) : ''}
                        </div>
                    </div>
                    <div class="admin-task-status ${statusClass}">${statusText}</div>
                `;

                priorityContainer.appendChild(taskDiv);
            });
        }


        // This function needs to be defined as it's called in the HTML.
        // It's likely intended to update the task's status in the main list
        // and in the widget.
        function toggleTaskCompletion(taskId, isCompleted) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                // Changed logic: if unchecked, it goes to 'returned', not 'new'
                task.status = isCompleted ? 'completed' : 'returned';
                saveTasks();
                renderTasks();
                renderWidget();
            }
        }

        // Filtry
        function setupFilters() {
            document.getElementById('locationFilter').addEventListener('change', renderTasks);
            document.getElementById('userFilter').addEventListener('change', renderTasks);
        }

        // Zamykanie modali przy kliknięciu na tło
        window.onclick = function(event) {
            const taskModal = document.getElementById('taskModal');
            const confirmModal = document.getElementById('confirmModal');

            if (event.target === taskModal) {
                closeTaskModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }
    </script>
</body>
</html>